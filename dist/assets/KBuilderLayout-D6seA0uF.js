var oe=Object.defineProperty;var ne=(a,e,t)=>e in a?oe(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var U=(a,e,t)=>(ne(a,typeof e!="symbol"?e+"":e,t),t);import{l as X,d as b,r as ie,c as d,e as _,f,w as g,g as C,u as n,m as ce,n as ue,o as A,q as V,s as S,t as de,i as P,k as i,F as w,v as W,x as B,y as E,z as R,E as Q,A as T,B as F,C as pe,D as fe,G as q,H as L,p as Z,j as H,I as me,J as he,K as ye,L as _e,M as ke,N as G}from"./index-B-IgiOY6.js";import{_ as x,s as J}from"./_plugin-vue_export-helper-B1rwSs__.js";import{g as ee,a as ve,b as te}from"./cache-BqQ7ooJZ.js";var z=(a=>(a.ANALYZER="analyzer",a.MIXER="mixer",a))(z||{});const N=X({current:"analyzer"}),ge={class:"menu-wrapper"},Pe=b({__name:"KMenu",setup(a){const e=[{id:z.ANALYZER,icon:"monitoring",label:"Analyzer"},{id:z.MIXER,icon:"blender",label:"Mixer"}];return(t,s)=>{const l=ie("RouterLink");return d(),_("div",ge,[f(l,{class:"title",to:"/"},{default:g(()=>[C(" Kaleidoscope ")]),_:1}),f(n(ce),{modelValue:n(N).current,"onUpdate:modelValue":s[0]||(s[0]=r=>n(N).current=r),options:e},null,8,["modelValue"])])}}}),we=x(Pe,[["__scopeId","data-v-1c379e9c"]]),o=X({playlists:[],selectedPlaylist:"",selectedPlaylists:[],tracks:[]}),D=X({moveSource:""});function Y(){let a=0;for(const e of o.tracks)a+=e.duration_ms,e.total_duration=a}const I=ue("ks-local",{deployedPlaylists:!1}),$e={class:"filter"},be=b({__name:"KPlaylists",setup(a){A(async()=>{o.playlists=await ee()});function e(l){o.selectedPlaylist=l}const t=V(""),s=S(()=>o.playlists.filter(l=>l.name.toLowerCase().includes(t.value.toLowerCase())));return de(()=>{o.selectedPlaylist=""}),(l,r)=>(d(),P(n(F),{class:"playlists-wrapper",depth:-2},{default:g(()=>[i("div",$e,[f(n(w),{icon:n(I).deployedPlaylists?"expand_more":"chevron_right",squared:"",onClick:r[0]||(r[0]=c=>n(I).deployedPlaylists=!n(I).deployedPlaylists)},null,8,["icon"]),f(n(W),{modelValue:t.value,"onUpdate:modelValue":r[1]||(r[1]=c=>t.value=c),class:"text-input",icon:"search",placeholder:"Filter playlists"},null,8,["modelValue"])]),i("div",{class:B(["playlists",{expanded:n(I).deployedPlaylists}])},[(d(!0),_(E,null,R(s.value,c=>(d(),_("div",{key:c.id,class:"playlist"},[f(n(w),{icon:n(o).selectedPlaylist===c.id?"radio_button_checked":"radio_button_unchecked",type:n(o).selectedPlaylist===c.id?n(Q).Primary:n(Q).Default,onClick:v=>e(c.id)},{default:g(()=>[C(T(c.name),1)]),_:2},1032,["icon","type","onClick"])]))),128))],2)]),_:1}))}}),Me=x(be,[["__scopeId","data-v-f11049b4"]]),Se={class:"percentage-display"},Te={class:"value"},xe=b({__name:"KPercentageDisplay",props:{colorMax:{default:"#0000bb"},colorMin:{default:"#770000"},max:{default:1},min:{default:0},value:{}},setup(a){const e=a,t=S(()=>`${(e.value-e.min)/(e.max-e.min)*100}%`),s=S(()=>e.max===1?`${Math.round(e.value*100)}%`:Math.round(e.value)),l=S(()=>{const c=(e.value-e.min)/(e.max-e.min);return Math.min(1,Math.max(0,c))}),r=S(()=>`color-mix(in lch, ${e.colorMax} ${l.value*100}%, ${e.colorMin})`);return(c,v)=>(d(),_("div",Se,[i("div",{class:"percentage",style:pe({width:t.value,backgroundColor:r.value})},null,4),i("div",Te,T(s.value),1)]))}}),K=x(xe,[["__scopeId","data-v-f337ce27"]]),ae=a=>(Z("data-v-d9109fef"),a=a(),H(),a),Ce=["draggable"],Ie={class:"index"},De={class:"time"},Ve={class:"cover"},Ke={class:"cover-wrapper"},Le=["src"],Ee=["title"],Be=["title"],Fe={key:1,class:"loading"},ze={key:1,class:"loading"},Ne={key:1,class:"loading"},Ae={key:1,class:"loading"},Re=ae(()=>i("div",{class:"insert-line"},null,-1)),Ye=[Re],Oe=ae(()=>i("div",{class:"insert-line"},null,-1)),Ue=[Oe],qe=b({__name:"KTrack",props:{index:{},track:{}},setup(a){const e=a;S(()=>e.track.album&&e.track.artists&&e.track.features);function t(u){return new Date(u).getFullYear()}const s=V(!1);function l(){s.value=!0}function r(){D.moveSource=e.track.id}function c(){s.value=!1,D.moveSource=""}const v=V("");function y(u){v.value=u}function p(u){v.value===u&&(v.value="")}function k(u){if(D.moveSource!==e.track.id){const m=o.tracks.findIndex(O=>O.id===D.moveSource),$=o.tracks[m];o.tracks.splice(m,1);const M=o.tracks.findIndex(O=>O.id===e.track.id);o.tracks.splice(M+(u==="before"?0:1),0,$),Y()}v.value="",s.value=!1,D.moveSource=""}function h(u){const m=Math.floor(u/36e5),$=Math.floor(u%36e5/6e4);return`${m}:${$.toString().padStart(2,"0")}`}return(u,m)=>{var $;return d(),_("tr",{class:B(["track",{dragging:s.value}]),draggable:s.value,onDragend:c,onDragstart:r},[i("td",{class:"drag",onMousedown:q(l,["stop"])},[f(n(fe),{icon:"drag_indicator"})],32),i("td",Ie,T(u.index+1),1),i("td",De,T(h(u.track.total_duration)),1),i("td",Ve,[i("div",Ke,[i("img",{alt:"Album cover",src:($=u.track.album.images[0])==null?void 0:$.url},null,8,Le)])]),i("td",null,[i("div",{class:"big",title:u.track.name},T(u.track.name),9,Ee)]),i("td",null,[i("div",{class:"big",title:u.track.artists[0].name},T(u.track.artists[0].name),9,Be)]),i("td",null,[f(K,{max:2025,min:1980,value:t(u.track.album.release_date)},null,8,["value"])]),i("td",null,[f(K,{value:u.track.popularity/100},null,8,["value"])]),i("td",null,[u.track.features?(d(),P(K,{key:0,max:160,min:80,value:u.track.features.tempo},null,8,["value"])):(d(),_("span",Fe,"Loading..."))]),i("td",null,[u.track.features?(d(),P(K,{key:0,value:u.track.features.danceability},null,8,["value"])):(d(),_("span",ze,"Loading..."))]),i("td",null,[u.track.features?(d(),P(K,{key:0,value:u.track.features.energy},null,8,["value"])):(d(),_("span",Ne,"Loading..."))]),i("td",null,[u.track.features?(d(),P(K,{key:0,value:u.track.features.valence},null,8,["value"])):(d(),_("span",Ae,"Loading..."))]),n(D).moveSource?(d(),_("div",{key:0,class:B(["drop-zone before",{hover:v.value==="before"}]),onDragenter:m[0]||(m[0]=M=>y("before")),onDragleave:m[1]||(m[1]=M=>p("before")),onDragover:m[2]||(m[2]=q(()=>{},["prevent"])),onDrop:m[3]||(m[3]=M=>k("before"))},Ye,34)):L("",!0),n(D).moveSource?(d(),_("div",{key:1,class:B(["drop-zone after",{hover:v.value==="after"}]),onDragenter:m[4]||(m[4]=M=>y("after")),onDragleave:m[5]||(m[5]=M=>p("after")),onDragover:m[6]||(m[6]=q(()=>{},["prevent"])),onDrop:m[7]||(m[7]=M=>k("after"))},Ue,34)):L("",!0)],42,Ce)}}}),Ge=x(qe,[["__scopeId","data-v-d9109fef"]]);class Je{constructor(e){U(this,"tracks",[]);U(this,"thresholds",{energy:0,popular:0,retro:0,speed:0});this.tracks=[...e]}generateThresholds(){this.tracks.sort((e,t)=>e.popularity-t.popularity),this.thresholds.popular=this.tracks[Math.floor(this.tracks.length*.5)].popularity,this.tracks.sort((e,t)=>e.features.energy-t.features.energy),this.thresholds.energy=this.tracks[Math.floor(this.tracks.length*.5)].features.energy,this.tracks.sort((e,t)=>e.features.tempo-t.features.tempo),this.thresholds.speed=this.tracks[Math.floor(this.tracks.length*.5)].features.tempo,this.tracks.sort((e,t)=>e.album.release_date.localeCompare(t.album.release_date)),this.thresholds.retro=new Date(this.tracks[Math.floor(this.tracks.length*.5)].album.release_date).getFullYear()}removeTrack(e){this.tracks.splice(this.tracks.indexOf(e),1)}getTrack(e){let t=[...this.tracks];if(e.filter.retro){const s=t.filter(l=>new Date(l.album.release_date).getFullYear()*e.filter.retro<=this.thresholds.retro*e.filter.retro);t=s.length?s:t}if(e.filter.speed){const s=t.filter(l=>l.features.tempo*e.filter.speed>=this.thresholds.speed*e.filter.speed);t=s.length?s:t}if(e.filter.popular){const s=t.filter(l=>l.popularity*e.filter.popular>=this.thresholds.popular*e.filter.popular);t=s.length?s:t}if(e.filter.energy){const s=t.filter(l=>l.features.energy*e.filter.energy>=this.thresholds.energy*e.filter.energy);t=s.length?s:t}if(e.limit.retro){t.sort((l,r)=>(new Date(l.album.release_date).getFullYear()-new Date(r.album.release_date).getFullYear())*e.limit.retro);const s=Math.floor(t.length*Math.abs(e.limit.retro));t.length=s||1}if(e.limit.speed){t.sort((l,r)=>(r.features.tempo-l.features.tempo)*e.limit.speed);const s=Math.floor(t.length*Math.abs(e.limit.speed));t.length=s||1}if(e.limit.popular){t.sort((l,r)=>(r.popularity-l.popularity)*e.limit.popular);const s=Math.floor(t.length*Math.abs(e.limit.popular));t.length=s||1}if(e.limit.energy){t.sort((l,r)=>(r.features.energy-l.features.energy)*e.limit.energy);const s=Math.floor(t.length*Math.abs(e.limit.energy));t.length=s||1}return t[Math.floor(t.length*Math.random())]}getSafeTrack(e){const t=e??this.tracks[Math.floor(this.tracks.length*Math.random())];return this.removeTrack(t),t}}function Xe(){const a=[...o.tracks];for(o.tracks=[];a.length;){const e=Math.floor(Math.random()*a.length);o.tracks.push(a.splice(e,1)[0])}Y()}function Ze(){const a=new Je(o.tracks);a.generateThresholds();const e=[],t=o.tracks.reduce((v,y)=>v+y.duration_ms,0);let s=0,l;l=a.getSafeTrack(a.getTrack({filter:{energy:1,popular:1,retro:-1},limit:{energy:.8}})),s+=l.duration_ms,e.push(l);let r=!1,c=!1;for(;s<t*.1;)c?c=!1:c=Math.random()>.25,l=a.getSafeTrack(a.getTrack({filter:{retro:c?1:-1,speed:r?-1:1},limit:{energy:.75,popular:.5,speed:.5}})),e.push(l),s+=l.duration_ms,r=!r;for(a.generateThresholds();s<t*.5;)c?c=!1:c=Math.random()>.25,l=a.getSafeTrack(a.getTrack({filter:{retro:c?1:-1,speed:r?-1:1},limit:{energy:.75,popular:.75,retro:Math.random()>.5?.25:0,speed:Math.random()>.5?.5:0}})),e.push(l),s+=l.duration_ms,r=!r;for(a.generateThresholds();s<t*.8;)c?c=!1:c=Math.random()>.25,l=a.getSafeTrack(a.getTrack({filter:{retro:c?1:0,speed:r?-1:1},limit:{energy:.75,popular:Math.random()>.5?.75:0,retro:Math.random()>.5?.25:0,speed:Math.random()>.5?.75:0}})),e.push(l),s+=l.duration_ms,r=!r;for(a.generateThresholds();a.tracks.length;)l=a.getSafeTrack(a.getTrack({filter:{speed:r?-1:1},limit:{}})),e.push(l),s+=l.duration_ms,r=!r;o.tracks=e,Y()}async function se(a,e){for(let t=0;t<e.length;t+=100)await J(`/playlists/${a}/tracks`,{body:JSON.stringify({tracks:e.slice(t,t+100).map(s=>({uri:`spotify:track:${s}`}))}),method:"DELETE"});for(let t=0;t<e.length;t+=100)await J(`/playlists/${a}/tracks`,{body:JSON.stringify({uris:e.slice(t,t+100).map(s=>`spotify:track:${s}`)}),method:"POST"})}async function He(a,e){const{id:t}=await J(`/users/${me.value}/playlists`,{body:JSON.stringify({name:a||"KS Export"}),method:"POST"});await se(t,e)}const je=a=>(Z("data-v-8399fc64"),a=a(),H(),a),Qe={class:"tracks-wrapper"},We=je(()=>i("tr",{class:"head"},[i("th",{colspan:"4"}),i("th",{class:"big"}," Name "),i("th",{class:"big"}," Artist "),i("th",{class:"value"}," Release "),i("th",{class:"value"}," Popularity "),i("th",{class:"value"}," Tempo "),i("th",{class:"value"}," Dance "),i("th",{class:"value"}," Energy "),i("th",{class:"value"}," Positive ")],-1)),et={class:"buttons"},tt=b({__name:"KTracks",setup(a){async function e(){const s=o.tracks.map(l=>l.id);await se(o.selectedPlaylist,s),alert("Playlist saved!")}async function t(){if(o.tracks.length===0){alert("No tracks to export!");return}let s=prompt("Enter playlist name");if(s===null)return;s||(s="KS Export");const l=o.tracks.map(r=>r.id);await He(s,l),alert("Playlist exported!")}return(s,l)=>(d(),_("div",Qe,[i("table",null,[We,(d(!0),_(E,null,R(n(o).tracks,(r,c)=>(d(),P(Ge,{key:r.id,index:c,track:r},null,8,["index","track"]))),128))]),i("div",et,[n(o).selectedPlaylist?(d(),P(n(w),{key:0,icon:"save",onClick:e},{default:g(()=>[C(" Save playlist ")]),_:1})):L("",!0),f(n(w),{icon:"publish",onClick:t},{default:g(()=>[C(" Export playlist ")]),_:1}),f(n(w),{icon:"shuffle",onClick:n(Xe)},{default:g(()=>[C(" Shuffle ")]),_:1},8,["onClick"]),f(n(w),{icon:"category",onClick:n(Ze)},{default:g(()=>[C(" Smart sort ")]),_:1},8,["onClick"])])]))}}),le=x(tt,[["__scopeId","data-v-8399fc64"]]);async function re(){await ve(o.tracks),Y()}const at=b({__name:"KLayoutAnalyzer",setup(a){return A(async()=>{o.tracks=[]}),he(()=>o.selectedPlaylist,async e=>{e&&(o.tracks=await te(e),await re())},{flush:"sync"}),(e,t)=>(d(),_(E,null,[f(Me),f(le)],64))}}),st={class:"filter"},lt=b({__name:"KPlaylistsMultiple",setup(a){A(async()=>{o.playlists=await ee()});function e(l){o.selectedPlaylists.push(l)}const t=V(""),s=S(()=>o.playlists.filter(l=>l.name.toLowerCase().includes(t.value.toLowerCase())));return(l,r)=>(d(),P(n(F),{class:"playlists-wrapper",depth:-2},{default:g(()=>[i("div",st,[f(n(w),{icon:n(I).deployedPlaylists?"expand_more":"chevron_right",squared:"",onClick:r[0]||(r[0]=c=>n(I).deployedPlaylists=!n(I).deployedPlaylists)},null,8,["icon"]),f(n(W),{modelValue:t.value,"onUpdate:modelValue":r[1]||(r[1]=c=>t.value=c),class:"text-input",icon:"search",placeholder:"Filter playlists"},null,8,["modelValue"])]),i("div",{class:B(["playlists",{expanded:n(I).deployedPlaylists}])},[(d(!0),_(E,null,R(s.value,c=>(d(),_("div",{key:c.id,class:"playlist"},[f(n(w),{icon:"add",onClick:v=>e(c.id)},{default:g(()=>[C(T(c.name),1)]),_:2},1032,["onClick"])]))),128))],2)]),_:1}))}}),rt=x(lt,[["__scopeId","data-v-63198692"]]),j=a=>(Z("data-v-97571f71"),a=a(),H(),a),ot={class:"options"},nt={class:"option"},it=j(()=>i("div",{class:"name"}," Mix mode ",-1)),ct={class:"form"},ut={class:"option"},dt=j(()=>i("div",{class:"name"}," Target duration (0 to disable) ",-1)),pt={class:"form"},ft={class:"option"},mt=j(()=>i("div",{class:"name"}," Remove duplicates ",-1)),ht={class:"form"},yt=b({__name:"KMixer",setup(a){const e=[{id:"BackToBack",label:"Back to back"},{id:"Interleaved",label:"Interleaved"},{id:"Progress",label:"Progress"}],t=V("BackToBack"),s=V(!0),l=V(0),r=S(()=>{const y=Math.floor(l.value/60),p=l.value%60;return`${y}h ${p}m`});async function c(){if(o.selectedPlaylists.length<1){alert("Select at least one playlist to merge");return}o.tracks=[];const y=[];for(const p of o.selectedPlaylists)y.push(await te(p));switch(t.value){case"BackToBack":if(o.tracks=y.flat(),s.value){const p=new Set;o.tracks=o.tracks.filter(k=>p.has(k.id)?!1:(p.add(k.id),!0))}break;case"Interleaved":{const p=Math.max(...y.map(h=>h.length)),k=new Set;for(let h=0;h<p;h++)for(const u of y){for(;s.value&&u[h]&&k.has(u[h].id);)u.splice(h,1);u[h]&&(o.tracks.push(u[h]),k.add(u[h].id))}}break;case"Progress":await v(y)}if(l.value>0)for(;o.tracks.reduce((p,k)=>p+k.duration_ms,0)>l.value*60*1e3;)o.tracks.splice(Math.floor(Math.random()*o.tracks.length),1);await re()}async function v(y){const p=[],k=new Set;for(const h of y){const u=h.reduce(($,M)=>$+M.duration_ms,0);let m=0;for(const $ of h)p.push({progress:m/u,track:$}),m+=$.duration_ms}for(const h of p){if(s.value&&k.has(h.track.id)){p.splice(p.indexOf(h),1);continue}k.add(h.track.id)}p.sort((h,u)=>h.progress-u.progress),o.tracks=p.map(h=>h.track)}return(y,p)=>(d(),P(n(F),{class:"mixer-wrapper",depth:-2},{default:g(()=>[i("div",ot,[i("div",nt,[it,i("div",ct,[f(n(ye),{modelValue:t.value,"onUpdate:modelValue":p[0]||(p[0]=k=>t.value=k),class:"select",options:e},null,8,["modelValue"])])]),i("div",ut,[dt,i("div",pt,[f(n(_e),{modelValue:l.value,"onUpdate:modelValue":p[1]||(p[1]=k=>l.value=k),clamp:"",class:"time",fixed:0,max:300,min:0,step:5,suffix:"min"},null,8,["modelValue"]),i("span",null,"("+T(r.value)+")",1)])]),i("div",ft,[mt,i("div",ht,[f(n(ke),{modelValue:s.value,"onUpdate:modelValue":p[2]||(p[2]=k=>s.value=k)},null,8,["modelValue"])])])]),f(n(w),{icon:"manufacturing",onClick:c},{default:g(()=>[C(" Generate ")]),_:1})]),_:1}))}}),_t=x(yt,[["__scopeId","data-v-97571f71"]]),kt={key:0,class:"playlist"},vt={class:"name"},gt={class:"actions"},Pt=b({__name:"KPlaylistsViewer",setup(a){const e=S(()=>o.playlists.reduce((r,c)=>(r[c.id]=c,r),{}));function t(r){if(r===0)return;const c=o.selectedPlaylists[r];o.selectedPlaylists[r]=o.selectedPlaylists[r-1],o.selectedPlaylists[r-1]=c}function s(r){if(r===o.selectedPlaylists.length-1)return;const c=o.selectedPlaylists[r];o.selectedPlaylists[r]=o.selectedPlaylists[r+1],o.selectedPlaylists[r+1]=c}function l(r){o.selectedPlaylists.splice(r,1)}return(r,c)=>(d(),P(n(F),{class:"playlists-viewer",depth:-2},{default:g(()=>[n(o).selectedPlaylists.length===0?(d(),_("div",kt," No playlist selected ")):L("",!0),(d(!0),_(E,null,R(n(o).selectedPlaylists,(v,y)=>(d(),P(n(F),{key:y,class:"playlist"},{default:g(()=>[i("div",vt,T(e.value[v].name),1),i("div",gt,[f(n(w),{icon:"arrow_back",size:n(G).Small,squared:"",onClick:p=>t(y)},null,8,["size","onClick"]),f(n(w),{icon:"arrow_forward",size:n(G).Small,squared:"",onClick:p=>s(y)},null,8,["size","onClick"]),f(n(w),{icon:"delete",size:n(G).Small,squared:"",onClick:p=>l(y)},null,8,["size","onClick"])])]),_:2},1024))),128))]),_:1}))}}),wt=x(Pt,[["__scopeId","data-v-50746a49"]]),$t=b({__name:"KLayoutMixer",setup(a){return A(async()=>{o.tracks=[]}),(e,t)=>(d(),_(E,null,[f(rt),f(wt),f(_t),f(le)],64))}}),bt={class:"layout"},Mt=b({__name:"KBuilderLayout",setup(a){return(e,t)=>(d(),_("div",bt,[f(we),n(N).current===n(z).ANALYZER?(d(),P(at,{key:0})):L("",!0),n(N).current===n(z).MIXER?(d(),P($t,{key:1})):L("",!0)]))}}),It=x(Mt,[["__scopeId","data-v-7e5f33db"]]);export{It as default};
