var ne=Object.defineProperty;var ie=(s,e,t)=>e in s?ne(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var G=(s,e,t)=>(ie(s,typeof e!="symbol"?e+"":e,t),t);import{n as H,d as w,r as ce,e as m,f as k,g as d,w as v,h as T,i as n,q as de,s as ue,o as R,t as K,v as z,x as pe,k as M,m as i,F as P,y as te,z as B,A as L,B as Y,E as ee,C as $,D as F,G as fe,H as J,I as E,p as j,l as Q,u as me,J as he,K as ye,L as _e,M as ke,N as X}from"./index-IYjx4zwS.js";import{_ as C,s as Z}from"./_plugin-vue_export-helper-CW8dRx5a.js";import{g as ae,K as V,a as ve,b as se}from"./KPercentageDisplay-LqrMdM6q.js";var N=(s=>(s.ANALYZER="analyzer",s.MIXER="mixer",s))(N||{});const A=H({current:"analyzer"}),ge={class:"menu-wrapper"},Pe=w({__name:"KMenu",setup(s){const e=[{id:N.ANALYZER,icon:"monitoring",label:"Analyzer"},{id:N.MIXER,icon:"blender",label:"Mixer"}];return(t,r)=>{const a=ce("RouterLink");return m(),k("div",ge,[d(a,{class:"title",to:"/"},{default:v(()=>[T(" Kaleidoscope ")]),_:1}),d(n(de),{modelValue:n(A).current,"onUpdate:modelValue":r[0]||(r[0]=l=>n(A).current=l),options:e},null,8,["modelValue"])])}}}),we=C(Pe,[["__scopeId","data-v-1c379e9c"]]),o=H({playlists:[],selectedPlaylist:"",selectedPlaylists:[],tracks:[]}),D=H({moveSource:""});function O(){let s=0;for(const e of o.tracks)s+=e.duration_ms,e.total_duration=s}const I=ue("ks-local",{deployedPlaylists:!1}),be={class:"filter"},$e=w({__name:"KPlaylists",setup(s){R(async()=>{o.playlists=await ae()});function e(a){o.selectedPlaylist=a}const t=K(""),r=z(()=>o.playlists.filter(a=>a.name.toLowerCase().includes(t.value.toLowerCase())));return pe(()=>{o.selectedPlaylist=""}),(a,l)=>(m(),M(n(F),{class:"playlists-wrapper",depth:-2},{default:v(()=>[i("div",be,[d(n(P),{icon:n(I).deployedPlaylists?"expand_more":"chevron_right",squared:"",onClick:l[0]||(l[0]=c=>n(I).deployedPlaylists=!n(I).deployedPlaylists)},null,8,["icon"]),d(n(te),{modelValue:t.value,"onUpdate:modelValue":l[1]||(l[1]=c=>t.value=c),class:"text-input",icon:"search",placeholder:"Filter playlists"},null,8,["modelValue"])]),i("div",{class:B(["playlists",{expanded:n(I).deployedPlaylists}])},[(m(!0),k(L,null,Y(r.value,c=>(m(),k("div",{key:c.id,class:"playlist"},[d(n(P),{icon:n(o).selectedPlaylist===c.id?"radio_button_checked":"radio_button_unchecked",type:n(o).selectedPlaylist===c.id?n(ee).Primary:n(ee).Default,onClick:b=>e(c.id)},{default:v(()=>[T($(c.name),1)]),_:2},1032,["icon","type","onClick"])]))),128))],2)]),_:1}))}}),Me=C($e,[["__scopeId","data-v-f11049b4"]]),U=s=>(j("data-v-43ab0a2a"),s=s(),Q(),s),Se=["draggable"],Te={class:"index"},Ie={class:"time"},Ce={class:"cover"},xe={class:"cover-wrapper"},De=["src"],Ke=["title"],Ve=["title"],Ee=U(()=>i("div",{class:"insert-line"},null,-1)),Le=[Ee],Be=U(()=>i("div",{class:"insert-line"},null,-1)),Fe=[Be],Ne={key:1},ze=U(()=>i("td",{colspan:"4"},null,-1)),Ae={class:"big"},Re=U(()=>i("td",{colspan:7}," Loading... ",-1)),Ye=w({__name:"KTrack",props:{index:{},track:{}},setup(s){const e=s,t=z(()=>e.track.album&&e.track.artists&&e.track.features);function r(p){return new Date(p).getFullYear()}const a=K(!1);function l(){a.value=!0}function c(){D.moveSource=e.track.id}function b(){a.value=!1,D.moveSource=""}const h=K("");function u(p){h.value=p}function _(p){h.value===p&&(h.value="")}function y(p){if(D.moveSource!==e.track.id){const f=o.tracks.findIndex(q=>q.id===D.moveSource),S=o.tracks[f];o.tracks.splice(f,1);const x=o.tracks.findIndex(q=>q.id===e.track.id);o.tracks.splice(x+(p==="before"?0:1),0,S),O()}h.value="",a.value=!1,D.moveSource=""}function g(p){const f=Math.floor(p/36e5),S=Math.floor(p%36e5/6e4);return`${f}:${S.toString().padStart(2,"0")}`}return(p,f)=>{var S;return t.value?(m(),k("tr",{key:0,class:B(["track",{dragging:a.value}]),draggable:a.value,onDragend:b,onDragstart:c},[i("td",{class:"drag",onMousedown:J(l,["stop"])},[d(n(fe),{icon:"drag_indicator"})],32),i("td",Te,$(p.index+1),1),i("td",Ie,$(g(p.track.total_duration)),1),i("td",Ce,[i("div",xe,[i("img",{alt:"Album cover",src:(S=p.track.album.images[0])==null?void 0:S.url},null,8,De)])]),i("td",null,[i("div",{class:"big",title:p.track.name},$(p.track.name),9,Ke)]),i("td",null,[i("div",{class:"big",title:p.track.artists[0].name},$(p.track.artists[0].name),9,Ve)]),i("td",null,[d(V,{max:2025,min:1980,value:r(p.track.album.release_date)},null,8,["value"])]),i("td",null,[d(V,{value:p.track.popularity/100},null,8,["value"])]),i("td",null,[d(V,{max:160,min:80,value:p.track.features.tempo},null,8,["value"])]),i("td",null,[d(V,{value:p.track.features.danceability},null,8,["value"])]),i("td",null,[d(V,{value:p.track.features.energy},null,8,["value"])]),i("td",null,[d(V,{value:p.track.features.valence},null,8,["value"])]),n(D).moveSource?(m(),k("div",{key:0,class:B(["drop-zone before",{hover:h.value==="before"}]),onDragenter:f[0]||(f[0]=x=>u("before")),onDragleave:f[1]||(f[1]=x=>_("before")),onDragover:f[2]||(f[2]=J(()=>{},["prevent"])),onDrop:f[3]||(f[3]=x=>y("before"))},Le,34)):E("",!0),n(D).moveSource?(m(),k("div",{key:1,class:B(["drop-zone after",{hover:h.value==="after"}]),onDragenter:f[4]||(f[4]=x=>u("after")),onDragleave:f[5]||(f[5]=x=>_("after")),onDragover:f[6]||(f[6]=J(()=>{},["prevent"])),onDrop:f[7]||(f[7]=x=>y("after"))},Fe,34)):E("",!0)],42,Se)):(m(),k("tr",Ne,[ze,i("td",null,[i("div",Ae,$(p.track.name),1)]),Re]))}}}),Oe=C(Ye,[["__scopeId","data-v-43ab0a2a"]]);class Ue{constructor(e){G(this,"tracks",[]);G(this,"thresholds",{energy:0,popular:0,retro:0,speed:0});this.tracks=[...e]}generateThresholds(){this.tracks.sort((e,t)=>e.popularity-t.popularity),this.thresholds.popular=this.tracks[Math.floor(this.tracks.length*.5)].popularity,this.tracks.sort((e,t)=>e.features.energy-t.features.energy),this.thresholds.energy=this.tracks[Math.floor(this.tracks.length*.5)].features.energy,this.tracks.sort((e,t)=>e.features.tempo-t.features.tempo),this.thresholds.speed=this.tracks[Math.floor(this.tracks.length*.5)].features.tempo,this.tracks.sort((e,t)=>e.album.release_date.localeCompare(t.album.release_date)),this.thresholds.retro=new Date(this.tracks[Math.floor(this.tracks.length*.5)].album.release_date).getFullYear()}removeTrack(e){this.tracks.splice(this.tracks.indexOf(e),1)}getTrack(e){let t=[...this.tracks];if(e.filter.retro){const r=t.filter(a=>new Date(a.album.release_date).getFullYear()*e.filter.retro<=this.thresholds.retro*e.filter.retro);t=r.length?r:t}if(e.filter.speed){const r=t.filter(a=>a.features.tempo*e.filter.speed>=this.thresholds.speed*e.filter.speed);t=r.length?r:t}if(e.filter.popular){const r=t.filter(a=>a.popularity*e.filter.popular>=this.thresholds.popular*e.filter.popular);t=r.length?r:t}if(e.filter.energy){const r=t.filter(a=>a.features.energy*e.filter.energy>=this.thresholds.energy*e.filter.energy);t=r.length?r:t}if(e.limit.retro){t.sort((a,l)=>(new Date(a.album.release_date).getFullYear()-new Date(l.album.release_date).getFullYear())*e.limit.retro);const r=Math.floor(t.length*Math.abs(e.limit.retro));t.length=r||1}if(e.limit.speed){t.sort((a,l)=>(l.features.tempo-a.features.tempo)*e.limit.speed);const r=Math.floor(t.length*Math.abs(e.limit.speed));t.length=r||1}if(e.limit.popular){t.sort((a,l)=>(l.popularity-a.popularity)*e.limit.popular);const r=Math.floor(t.length*Math.abs(e.limit.popular));t.length=r||1}if(e.limit.energy){t.sort((a,l)=>(l.features.energy-a.features.energy)*e.limit.energy);const r=Math.floor(t.length*Math.abs(e.limit.energy));t.length=r||1}return t[Math.floor(t.length*Math.random())]}getSafeTrack(e){const t=e??this.tracks[Math.floor(this.tracks.length*Math.random())];return this.removeTrack(t),t}}function qe(){const s=[...o.tracks];for(o.tracks=[];s.length;){const e=Math.floor(Math.random()*s.length);o.tracks.push(s.splice(e,1)[0])}O()}function Ge(){const s=new Ue(o.tracks);s.generateThresholds();const e=[],t=o.tracks.reduce((b,h)=>b+h.duration_ms,0);let r=0,a;a=s.getSafeTrack(s.getTrack({filter:{energy:1,popular:1,retro:-1},limit:{energy:.8}})),r+=a.duration_ms,e.push(a);let l=!1,c=!1;for(;r<t*.1;)c?c=!1:c=Math.random()>.25,a=s.getSafeTrack(s.getTrack({filter:{retro:c?1:-1,speed:l?-1:1},limit:{energy:.75,popular:.5,speed:.5}})),e.push(a),r+=a.duration_ms,l=!l;for(s.generateThresholds();r<t*.5;)c?c=!1:c=Math.random()>.25,a=s.getSafeTrack(s.getTrack({filter:{retro:c?1:-1,speed:l?-1:1},limit:{energy:.75,popular:.75,retro:Math.random()>.5?.25:0,speed:Math.random()>.5?.5:0}})),e.push(a),r+=a.duration_ms,l=!l;for(s.generateThresholds();r<t*.8;)c?c=!1:c=Math.random()>.25,a=s.getSafeTrack(s.getTrack({filter:{retro:c?1:0,speed:l?-1:1},limit:{energy:.75,popular:Math.random()>.5?.75:0,retro:Math.random()>.5?.25:0,speed:Math.random()>.5?.75:0}})),e.push(a),r+=a.duration_ms,l=!l;for(s.generateThresholds();s.tracks.length;)a=s.getSafeTrack(s.getTrack({filter:{speed:l?-1:1},limit:{}})),e.push(a),r+=a.duration_ms,l=!l;o.tracks=e,O()}async function le(s,e){for(let t=0;t<e.length;t+=100)await Z(`/playlists/${s}/tracks`,{body:JSON.stringify({tracks:e.slice(t,t+100).map(r=>({uri:`spotify:track:${r}`}))}),method:"DELETE"});for(let t=0;t<e.length;t+=100)await Z(`/playlists/${s}/tracks`,{body:JSON.stringify({uris:e.slice(t,t+100).map(r=>`spotify:track:${r}`)}),method:"POST"})}async function Je(s,e){const{id:t}=await Z(`/users/${me.value}/playlists`,{body:JSON.stringify({name:s||"KS Export"}),method:"POST"});await le(t,e)}const Xe=s=>(j("data-v-8399fc64"),s=s(),Q(),s),Ze={class:"tracks-wrapper"},He=Xe(()=>i("tr",{class:"head"},[i("th",{colspan:"4"}),i("th",{class:"big"}," Name "),i("th",{class:"big"}," Artist "),i("th",{class:"value"}," Release "),i("th",{class:"value"}," Popularity "),i("th",{class:"value"}," Tempo "),i("th",{class:"value"}," Dance "),i("th",{class:"value"}," Energy "),i("th",{class:"value"}," Positive ")],-1)),je={class:"buttons"},Qe=w({__name:"KTracks",setup(s){async function e(){const r=o.tracks.map(a=>a.id);await le(o.selectedPlaylist,r),alert("Playlist saved!")}async function t(){if(o.tracks.length===0){alert("No tracks to export!");return}let r=prompt("Enter playlist name");if(r===null)return;r||(r="KS Export");const a=o.tracks.map(l=>l.id);await Je(r,a),alert("Playlist exported!")}return(r,a)=>(m(),k("div",Ze,[i("table",null,[He,(m(!0),k(L,null,Y(n(o).tracks,(l,c)=>(m(),M(Oe,{key:l.id,index:c,track:l},null,8,["index","track"]))),128))]),i("div",je,[n(o).selectedPlaylist?(m(),M(n(P),{key:0,icon:"save",onClick:e},{default:v(()=>[T(" Save playlist ")]),_:1})):E("",!0),d(n(P),{icon:"publish",onClick:t},{default:v(()=>[T(" Export playlist ")]),_:1}),d(n(P),{icon:"shuffle",onClick:n(qe)},{default:v(()=>[T(" Shuffle ")]),_:1},8,["onClick"]),d(n(P),{icon:"category",onClick:n(Ge)},{default:v(()=>[T(" Smart sort ")]),_:1},8,["onClick"])])]))}}),re=C(Qe,[["__scopeId","data-v-8399fc64"]]);async function oe(){await ve(o.tracks),O()}const We=w({__name:"KLayoutAnalyzer",setup(s){return R(async()=>{o.tracks=[]}),he(()=>o.selectedPlaylist,async e=>{e&&(o.tracks=await se(e),await oe())},{flush:"sync"}),(e,t)=>(m(),k(L,null,[d(Me),d(re)],64))}}),et={class:"filter"},tt=w({__name:"KPlaylistsMultiple",setup(s){R(async()=>{o.playlists=await ae()});function e(a){o.selectedPlaylists.push(a)}const t=K(""),r=z(()=>o.playlists.filter(a=>a.name.toLowerCase().includes(t.value.toLowerCase())));return(a,l)=>(m(),M(n(F),{class:"playlists-wrapper",depth:-2},{default:v(()=>[i("div",et,[d(n(P),{icon:n(I).deployedPlaylists?"expand_more":"chevron_right",squared:"",onClick:l[0]||(l[0]=c=>n(I).deployedPlaylists=!n(I).deployedPlaylists)},null,8,["icon"]),d(n(te),{modelValue:t.value,"onUpdate:modelValue":l[1]||(l[1]=c=>t.value=c),class:"text-input",icon:"search",placeholder:"Filter playlists"},null,8,["modelValue"])]),i("div",{class:B(["playlists",{expanded:n(I).deployedPlaylists}])},[(m(!0),k(L,null,Y(r.value,c=>(m(),k("div",{key:c.id,class:"playlist"},[d(n(P),{icon:"add",onClick:b=>e(c.id)},{default:v(()=>[T($(c.name),1)]),_:2},1032,["onClick"])]))),128))],2)]),_:1}))}}),at=C(tt,[["__scopeId","data-v-63198692"]]),W=s=>(j("data-v-97571f71"),s=s(),Q(),s),st={class:"options"},lt={class:"option"},rt=W(()=>i("div",{class:"name"}," Mix mode ",-1)),ot={class:"form"},nt={class:"option"},it=W(()=>i("div",{class:"name"}," Target duration (0 to disable) ",-1)),ct={class:"form"},dt={class:"option"},ut=W(()=>i("div",{class:"name"}," Remove duplicates ",-1)),pt={class:"form"},ft=w({__name:"KMixer",setup(s){const e=[{id:"BackToBack",label:"Back to back"},{id:"Interleaved",label:"Interleaved"},{id:"Progress",label:"Progress"}],t=K("BackToBack"),r=K(!0),a=K(0),l=z(()=>{const h=Math.floor(a.value/60),u=a.value%60;return`${h}h ${u}m`});async function c(){if(o.selectedPlaylists.length<1){alert("Select at least one playlist to merge");return}o.tracks=[];const h=[];for(const u of o.selectedPlaylists)h.push(await se(u));switch(t.value){case"BackToBack":if(o.tracks=h.flat(),r.value){const u=new Set;o.tracks=o.tracks.filter(_=>u.has(_.id)?!1:(u.add(_.id),!0))}break;case"Interleaved":{const u=Math.max(...h.map(y=>y.length)),_=new Set;for(let y=0;y<u;y++)for(const g of h){for(;r.value&&g[y]&&_.has(g[y].id);)g.splice(y,1);g[y]&&(o.tracks.push(g[y]),_.add(g[y].id))}}break;case"Progress":await b(h)}if(a.value>0)for(;o.tracks.reduce((u,_)=>u+_.duration_ms,0)>a.value*60*1e3;)o.tracks.splice(Math.floor(Math.random()*o.tracks.length),1);await oe()}async function b(h){const u=[],_=new Set;for(const y of h){const g=y.reduce((f,S)=>f+S.duration_ms,0);let p=0;for(const f of y)u.push({progress:p/g,track:f}),p+=f.duration_ms}for(const y of u){if(r.value&&_.has(y.track.id)){u.splice(u.indexOf(y),1);continue}_.add(y.track.id)}u.sort((y,g)=>y.progress-g.progress),o.tracks=u.map(y=>y.track)}return(h,u)=>(m(),M(n(F),{class:"mixer-wrapper",depth:-2},{default:v(()=>[i("div",st,[i("div",lt,[rt,i("div",ot,[d(n(ye),{modelValue:t.value,"onUpdate:modelValue":u[0]||(u[0]=_=>t.value=_),class:"select",options:e},null,8,["modelValue"])])]),i("div",nt,[it,i("div",ct,[d(n(_e),{modelValue:a.value,"onUpdate:modelValue":u[1]||(u[1]=_=>a.value=_),clamp:"",class:"time",fixed:0,max:300,min:0,step:5,suffix:"min"},null,8,["modelValue"]),i("span",null,"("+$(l.value)+")",1)])]),i("div",dt,[ut,i("div",pt,[d(n(ke),{modelValue:r.value,"onUpdate:modelValue":u[2]||(u[2]=_=>r.value=_)},null,8,["modelValue"])])])]),d(n(P),{icon:"manufacturing",onClick:c},{default:v(()=>[T(" Generate ")]),_:1})]),_:1}))}}),mt=C(ft,[["__scopeId","data-v-97571f71"]]),ht={key:0,class:"playlist"},yt={class:"name"},_t={class:"actions"},kt=w({__name:"KPlaylistsViewer",setup(s){const e=z(()=>o.playlists.reduce((l,c)=>(l[c.id]=c,l),{}));function t(l){if(l===0)return;const c=o.selectedPlaylists[l];o.selectedPlaylists[l]=o.selectedPlaylists[l-1],o.selectedPlaylists[l-1]=c}function r(l){if(l===o.selectedPlaylists.length-1)return;const c=o.selectedPlaylists[l];o.selectedPlaylists[l]=o.selectedPlaylists[l+1],o.selectedPlaylists[l+1]=c}function a(l){o.selectedPlaylists.splice(l,1)}return(l,c)=>(m(),M(n(F),{class:"playlists-viewer",depth:-2},{default:v(()=>[n(o).selectedPlaylists.length===0?(m(),k("div",ht," No playlist selected ")):E("",!0),(m(!0),k(L,null,Y(n(o).selectedPlaylists,(b,h)=>(m(),M(n(F),{key:h,class:"playlist"},{default:v(()=>[i("div",yt,$(e.value[b].name),1),i("div",_t,[d(n(P),{icon:"arrow_back",size:n(X).Small,squared:"",onClick:u=>t(h)},null,8,["size","onClick"]),d(n(P),{icon:"arrow_forward",size:n(X).Small,squared:"",onClick:u=>r(h)},null,8,["size","onClick"]),d(n(P),{icon:"delete",size:n(X).Small,squared:"",onClick:u=>a(h)},null,8,["size","onClick"])])]),_:2},1024))),128))]),_:1}))}}),vt=C(kt,[["__scopeId","data-v-50746a49"]]),gt=w({__name:"KLayoutMixer",setup(s){return R(async()=>{o.tracks=[]}),(e,t)=>(m(),k(L,null,[d(at),d(vt),d(mt),d(re)],64))}}),Pt={class:"layout"},wt=w({__name:"KBuilderLayout",setup(s){return(e,t)=>(m(),k("div",Pt,[d(we),n(A).current===n(N).ANALYZER?(m(),M(We,{key:0})):E("",!0),n(A).current===n(N).MIXER?(m(),M(gt,{key:1})):E("",!0)]))}}),Tt=C(wt,[["__scopeId","data-v-7e5f33db"]]);export{Tt as default};
